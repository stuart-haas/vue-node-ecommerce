extends ../layout

block css
  style(type="text/css").
    .card-item {
      transition: all .3s ease;
      -webkit-transition: all .3s ease;
      -ms-transition: all .3s ease;
      -moz-transition: all .3s ease;
      -o-transition: all .3s ease
    }
    .card {
      position: relative;
    }
    .card:hover .delete {
      display: block;
    }
    .card .delete {
      display: none;
      position: absolute;
      top: 8px;
      left: 8px;
    }

block content
  nav.navbar.has-shadow
    div.navbar-start
      a(href="/").navbar-item.title.is-1 Sonar
    div.navbar-end
      div.navbar-item
        p=`You are logged in as ${data.user.username}`
      a(href="/account").navbar-item
        span.icon.is-large
          i.fas.fa-user-circle.fa-2x
      a(href="/logout").navbar-item
        span.icon.is-large
          i.fas.fa-sign-out-alt.fa-2x
  div.columns.is-gapless
    aside.menu.column.is-2.is-narrow-mobile.is-hidden-mobile
      section.section
        p.menu-label General
        ul.menu-list
          li
            a(href="/dashboard").is-active Dashboard
          li
            a(href="/account") Account
          li
            a(href="/settings") Settings
    div.column.is-10
      section.section
        div.columns.is-vcentered.is-centered.is-desktop
          div.column
            form(action="/images/upload", method="post", enctype="multipart/form-data").dropzone#dropzoneForm
      section.section
        div#images.columns.is-multiline

block scripts
  script(type="text/javascript").

    Dropzone.options.dropzoneForm = {
      dictDefaultMessage: 'Drop file here or click to upload',
      addRemoveLinks: true,
      init: function () {
        this.on("success", function(file, response) {
          this.removeFile(file);
          appendImage(response, response.data);
        })
      }
    };
    
    function ajax(type, url, errorCallback, successCallback) {
      $.ajax({
        type: type,
        url: url,
        error: errorCallback,
        success: successCallback
      });
    }

    function ajaxError(error) {
      console.log(error);
    }

    function appendImage(image, data) {
      var predictionData = JSON.parse(data);
      var $el = 
      '<div class="card-item column is-3-desktop is-4-tablet">' +
        '<div class="card">' +
          '<a class="delete is-large has-background-danger" data-id="'+image.id+'"></a>' +
          '<figured class="image.is-4by3">' + 
            '<img src="'+image.path+'">' +
            '<figcaption>'+'</figcaption>' +
          '</figure>' +
          '<div class="card-content">' + 
            '<div class="content">' +
              '<p class="is-size-6">Classification: '+predictionData[0].payload[0].displayName+'<br>' +
              'Score: '+(predictionData[0].payload[0].classification.score * 100).toFixed(2)+"&#37;"+'</p>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
      $('#images').append($el);
    }

    function removeImage(response) {
      var id = response.id;
      $("[data-id='"+id+"']").parents('.card-item').remove();
    }

    function appendImages(response) {
      for(var i = 0; i < response.length; i ++) {
        var image = response[i];
        appendImage(image, image.prediction.data);
      }
    }

    $(document).on('click', '.delete', function(e) {
      e.preventDefault();

      var id = $(this).data('id');

      if (confirm('Are you sure you want to delete this image?')) {
        ajax('delete', '/images/' + id, ajaxError, removeImage);
      }
    })

    ajax('get', '/images', ajaxError, appendImages);